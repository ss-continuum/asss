
\documentclass{article}

% enlarge the page a bit
\addtolength{\hoffset}{-1cm}
\addtolength{\textwidth}{1.6cm}

% make new commands to enforce some style
\newcommand{\command}[1]{\subsection{#1}}
\newcommand{\requiremod}[1]{\noindent\textbf{Requires module:} \texttt{#1}\\}
\newcommand{\targets}[1]{\noindent\textbf{Possible targets:} #1\\}
\newcommand{\args}[1]{\noindent\textbf{Arguments:} #1\\}
\newcommand{\asss}{\texttt{asss}}
\newcommand{\subgame}{\texttt{subgame}}

\title{\asss{} User's Guide}

\begin{document}

\maketitle

\section{Introduction}

\asss{} is a new server for Subspace/Continuum. It was written from
scratch by Grelminar (\verb/grelminar@yahoo.com/), with help from Mine
GO BOOM, Stag Shot, and divine.216. % and numpf, if he ever gets around to helping
The name \asss{} stands for ``a small subspace server.''

Although care has been taken to remain compatible with the original
Subspace server, known as \subgame{}, players, and especially staff and
admins, should be aware that \asss{} is a different piece of software. It
has many features that \subgame{} is missing, but it is also missing some
from \subgame{}. The features that are common to both may work different.
They will have different bugs. In short, don't expect everything to work
the same as in \subgame{}, because it won't.

\subsection{Platform and Requirements}

\asss{} was developed primarily on a Linux system on the Intel x86
platform. Although some effort has been spent making it run on Windows
also, people running it on non-Linux systems should not expect
everything to work perfectly: there may be missing features and it may
run slower.

The requirements for running \asss{} on Linux are very simple: The
system should have the pthreads library (any recent Linux system
should), Berkeley DB 1.85 (newer versions won't work), and zlib. To
compile \asss{} from source (on either Linux or Windows), the include
files for those libraries must be installed, as well as a C compiler. If
you've obtained the source from CVS, you'll also need the Python
interpreter in order to generate certain files. If you're using a
tarball instead, it will come with those files present already.

Currently, only Intel platforms are supported because of byte-order
issues. Eventually, \asss{} will be able to run on other architectures,
but for now, Intel will have to do.


\subsection{Reporting Bugs}

There is an online bug-management system set up at this url:

\verb|http://asss.yi.org:2400/asss/|

\noindent You don't need an account to create new tickets, although you
do to modify them. Please check that you're not reporting a duplicate
bug before you submit a new ticker. And finally, it's running off of my
cable modem, so go easy on it.


\section{File Layout}
The server always access files relative to the directory it was started
from, which must have certain files and directories in certain places.
That means that to run multiple copies of the server on one machine, you
should make sure that each one is started from its own home directory.

Here's what a typical machine's file layout should look like:
\begin{verbatim}
/home/asss
+ bin
| + asss
| + commands.so
| + flags.so
| + balls.so
| + balls.so
| + ...
|
+ zone1 
| + news.txt
| + bin  (symlinked to ../bin)
| + defaultarena
| | + arena.conf
| | + scores.db
| |
| + arenas
| | + duel
| | | + arena.conf
| | | + scores.db
| | |
| | + pb
| |   + arena.conf
| |   + balls.conf
| |   + pb.lvl
| |   + scores.db
| |
| + conf
| | + global.conf
| | + modules.conf
| | + groupdef.conf
| | + groups
| | | + default
| | | + mod
| | | + smod
| | | + sysop
| | |
| | + defs.h
| | + svs
| |   + svs.conf
| |   + prizeweights
| |   + misc
| |   + ship-warbird
| |   + ...
| |
| + log
| | + asss.log
| | + asss.log.1
| |
| + maps
|   + zone1-pub.lvl
|   + another.lvl
|
+ zone2
  + bin  (symlinked to ../bin)
  + ...
\end{verbatim}

The most important directory is \verb/bin/. This directory should
contain the main \asss{} binary, as well as all files containing modules
to be loaded by the main binary. To ease administration, it is not
recommended that each zone on a machine have a full copy of the
\verb/bin/ directory. Rather, \verb/bin/ should be a symlink to a shared
directory containing binaries.

\verb/conf/ contains config files that affect the server as a whole.
Among the important files are \verb/modules.conf/, which specifies the
list of modules to load at startup, \verb/global.conf/, which contains
config settings for the whole server, \verb/groupdef.conf/, which
describes which capabilities belong to each group, and
\verb/staff.conf/, which assigns groups to various players.
\verb/groupdef.conf/ uses files in the \verb/groups/ subdirectory to
ensure more powerful groups have all the capabilities of lesser ones.

Also in \verb/conf/ is \verb/defs.h/, which includes a bunch of other
config files that are typically symlinks to files in the source code
directory. This is done to ensure the server and config files agree on
numerical values for various constants. All \verb/.conf/ files should
\verb/#include/ \verb/defs.h/.

\verb/conf/ can also contain partial config files for arenas to include.
The default directory structure contains an \verb/svs/ directory, with
the Standard VIE Settings, split into multiple files, by ship and
function.

\verb/log/ will be used by the server to deposit any log files that it
creates.

\verb/maps/ is an optional directory that the server will search for
\verb/.lvl/ files in. These files can also be located in arena
directories, so this isn't a required directory. It might simplify
administration, though, to keep all map files in this directory.

Each arena gets its own directory for storing settings related to that
arena, as well as persistent data for that arena.

The default arena (also called the public arena) keeps its data in the
directory \verb/defaultarena/, relative to the base directory for the
zone. All other arenas keep their files in \verb|arenas/foo|, where
\verb/foo/ is the name of the arena.

Each arena directory must contain a file named \verb/arena.conf/, which
contains the settings for that arena. For ease of administration, this
file may \verb/#include/ other config files in either the same
directory, or the global \verb/conf/ directory.

The server will create the file \verb/scores.db/ in each arena's
directory to keep track of players' scores for that arena. It will also
create \verb/global.db/ in the base of the zone directory for keeping
track of global persistent data.

The file \verb/news.txt/ should be located in the base of the zone
directory as well, unless another location is specified in
\verb/global.conf/.

\section{Modules}

Almost all of the functionality of \asss{} is split into many small
modules. The \asss{} binary itself contains a bunch of critical modules,
and other, less important, modules are in separate libraries with the
extension \verb/.so/ (on Unix) or \verb/.dll/ (on Windows). One shared
library can contain any number of modules.

There are currently
% grep 'int MM_' ~/src/asss/src/*.c | wc -l
40
modules that are part of \asss{}, but each zone might have some
custom-developed modules for their zone as well.

When the server starts up, it loads all of the modules listed in the
file \verb/modules.conf/. Once it's running, more modules can be loaded
with the \verb/?insmod/ command, and modules can be unloaded with
\verb/?rmmod/. The current list of loaded modules can be examined with
\verb/?lsmod/.

The \verb/modules.conf/ file has a special format that's slightly
different from the rest of the config files. It has no sections. Each
line should contain a ``module specifier.'' A module specifier is just
something of the form \verb/filename:module/. The filename part should
be the name of the file containing the module, without the extension.
The module part should be a module name that's contained in the file.
The colon separating them is just a colon. For modules that are in the
\asss{} binary itself, use the special file name \verb/int/ (for
``internal''). Comments are indicated by an initial semicolon or pound
sign.

If a particular zone has no need for a particular module (e.g., Chaos
zone doesn't have any flags or balls, so it doesn't need those modules),
it should't load those modules. Only loading the modules that are
actually used for a zone will decrease the memory usage of the server,
and make it run faster.

Once a module is loaded into the server, it has full access to the
server's data, including player ip addresses, machine id's, scores, and
passwords. It can also access files on the machine it is running on, and
make network connections, and it can easily crash or deadlock the
server. Thus, admins and sysops should be careful to only load modules
from sources that they trust.

In the future, it will be possible for some modules to run in separate
processes or even separate machines, it will be possible to write
modules in languages besides C, and it will be possible to limit the
information that modules have access to.


\section{Capabilities}

The old Subspace server supported a very limited notion of authority:
There were moderators, super moderators, and sysops. Each level allowed
access to more and more commands. Additionally, moderators and above
could see private freqs and private arenas, and bypass freq and arena
size limits.

\asss{} is much more flexible. It lets sysops and admins assign any set
of powers to any group of people. In the \asss{} model, each of the
above powers, plus a few more, like energy viewing, is assigned a
capability name. Each command also gets a capability name (actually,
each command gets two, one for using the command with public messages,
and one for using it with private messages). Whenever the server needs
to determine if a player can take a certain action, it asks the
capability manager, which replies either yes or no.

The server comes with one capability manager, contained in the
\texttt{capman} module, but there's no reason why another one couldn't
be used if your zone has peculiar needs for assigning people powers.

\subsection{Capablity names}

The most common capability names are for commands. If a player tries
to run a command, say, \verb/?lastlog/, the server would query the
capability manager with the name \verb/cmd_lastlog/. If a player uses a
command as a private message, as in \verb/:annoying_player:?freqkick/,
the capability name used would instead be \verb/privcmd_freqkick/.

There are several other capabilities that are currently used in the
server:

\begin{itemize}
\item{\texttt{seeprivarena}} controls whether private arena names are
sent to a player for the \verb/?arena/ command.
\item{\texttt{seeprivfreq}} determines if a player sees private freqs in
the freq listing.
\item{\texttt{findinprivs}} is needed by a player running \verb/?find/
for the server to report the names of private arenas. (Not implemented
yet.)
\item{\texttt{seeepd}} allows players to see other ship's energy and
specials from spectator mode. (``epd'' stands for extra position data.)
\item{\texttt{seesysoplogall}} allows a player to see all important log
messages in the zone.
\item{\texttt{seesysoplogarena}} only allows a player to see only
important log messages having to do with the arena he is currently in.
\item{\texttt{seemodchat}} allows players to see the moderator chat.
\item{\texttt{sendmodchat}} controls who can send moderator chat
messages. Usually, these two capabilities would be given to the same
people.
\item{\texttt{uploadfile}} allows a player to upload files. Note that
the player must also have the \texttt{cmd\_putfile} to upload a file
using that command.
\end{itemize}


\subsection{The default capability manager}

The default capability manager works with groups. Each group has a set
of capabilities, and players are assigned to groups. To check if a
player has a certain capability, the capability manager simply checks if
the group he's in has that capability.

To determine which groups have which capabilities, the
\verb/groupdef.conf/ file is used. It should have a section for each
group, and a line within that section for each capability.

To determine which players belong to which groups, the \verb/staff.conf/
file is used. It should have a single section, called ``Staff,'' with
player names as keys and group names as values. Players not listed in
the staff file will be assigned to the group ``default.'' If a player is
assigned a group in \verb/staff.conf/, he will be in that group in any
arena he enters.

Sometimes, however, a sysop will want to give certain players powers in
only certain arenas. Each arena's config file can also contain a
``Staff'' section. Groups assigned through arena config files will only
be valid in that one arena. Additionally, the global \verb/staff.conf/
can be used to give a player powers in only certain arenas by using a
value like ``arena1:agroup arena2:othergroup.''

The command \verb/?setgroup/ can be used to control group assignment.

\subsubsection{Emulating the old system}
Using the default manager, it's relatively easy to set up \asss{} to
emulate the old server's moderator, super moderator, and sysop model:
The \verb/groupdef.conf/ file looks like this:

\begin{verbatim}
; conf/groupdef.conf

[default]
#include groupdef.dir/default

[mod]
#include groupdef.dir/default
#include groupdef.dir/mod

[smod]
#include groupdef.dir/default
#include groupdef.dir/mod
#include groupdef.dir/smod

[sysop]
#include groupdef.dir/default
#include groupdef.dir/mod
#include groupdef.dir/smod
#include groupdef.dir/sysop
\end{verbatim}

The files in \verb/groupdef.dir/ contain simply lists of capabilities.
Each group includes the file for itself, as well as the files for the
lesser powerful groups.


\section{Logging}

\asss{} has extensive logging capabilities. Any remotely interesting
event in the game will generate a log message, which will be passed to
any number of loaded logging handlers.

\subsection{Levels}

There are five importance levels defined for log messages: DRIVEL is
unimportant information that you probably don't want to see, but is
logged anyway, just in case. INFO is basic information about common,
unexceptional events. MALICIOUS is for exceptional conditions that are
caused by players sending bad data to the server. These might be
indications of cheating or other illicit activity. They also might be
caused by abnormal network conditions. WARN is for error conditions that
can be worked around, or aren't too catcatastrophic. ERROR is for really
really horrible error conditions. These usually indicate misconfigured
servers or bugs in the server itself.

\subsection{What is logged?}

There are currently
% cat ~/src/asss/src/*.c | grep ">Log[AP]\?(L_" -c
155
distinct log messages in the server. By type, there are 26 ERROR
messages, 21 WARN messages, 50 MALICIOUS messages, 18 INFO messages, and
40 DRIVEL messages.

\subsection{Filtering}

Log handlers support a common method of filtering that give you lots of
control over which handlers see which messages.

By default, all messages are seen by all handlers. To limit messages to
a handler \verb/log_foo/, create a section with the same name as the
handler in \verb/global.conf/. The keys in that section will be module
names, and the values will be a set of priority levels to allow,
specified by listing the first letters of the allowed levels. The
special key \verb/all/ will be used for modules not listed. For example:

\begin{verbatim}
; this keeps flag positions and ball fires from appearing in the log
; file, but allows other DRIVEL messages.
[log_file]
all = DIMWE
flags = IMWE
balls = IMWE

; this allows all messages to go to the console except those from
; cmdman.
[log_console]
all = DIMWE
cmdman = none

; this lets only important messages (malicious and error) go to sysops
[log_sysop]
all = ME
\end{verbatim}


\subsection{Commands}

In general, all commands run by anyone are logged, at level INFO, along
with their parameters and targets. Some commands, however, contain
personal or sensitive information that might be abused by zone staff who
can view logs. To prevent this abuse, a list of commands can be defined
in the section named \verb/[DontLogParams]/ in \verb/global.conf/.
Commands listed here will have their parameters replaced by \verb/.../
when they appear in log messages.


\subsection{Handlers}

The current log handlers are:

\begin{itemize}

\item{\verb/log_console/} simply writes all log messages to standard
out, which is usually the terminal that \asss{} is started from.
Usually, \asss{} will run detached from any terminal, so this is
primarily intended for debugging.

\item{\verb/log_file/} write all log messages to a file. The name of the
file is controlled by the \verb/Log:LogFile/ configuration option. The
command \verb/?admlogfile/ may be used to flush or reopen the log file
while the server is running. \asss{} always appends to a single file. If
log rotation is desired, it should be accomplished with an external
program such as \verb/logrotate/.

\item{\verb/log_sysop/} informs players of log events within the game.
``Important'' messages, as defined by the logging filter, are sent to
players with the capabilities \verb/seesysoplogall/ and
\verb/seesysoplogarena/. Players with the latter capability only see log
messages that originated in the arena. This logging module also
implements the \verb/?lastlog/ command.

\end{itemize}


\section{New Features}

\subsection{Freq Ownership}

\requiremod{freqowners}
If the arena controller allows it, private freqs can now be owned. The
first player to move to a particular private freq becomes an owner for
that freq. An owner can kick non-owners off of his freq by sending them
the command \verb/?freqkick/. An owner can give owner privileges to
other players by sending them the command \verb/?giveowner/. The spec
freq can't be owned.

The config variable \texttt{Team:AllowFreqOwners} controls whether to
enable freq ownership. It defaults to on.

\subsection{Arena limiting}

\requiremod{arenaperm}
Any arena can specify a \texttt{General:NeedCap} value in it's config
file. If present, players will not be allowed to enter the arena unless
they have the specified capability.


\subsection{Autowarping}

\requiremod{autowarp}
Using the region system, certain areas of the map can be configured to
warp a player who enters them to somewhere else on the map.

FIXME: include details about specifying autowarp settings.


\subsection{Moderator chat}

\asss{} includes an actual moderator chat system, which should be an
improvement over the \verb/?cheater/-based systems in use currently.

Mod chat messages begin with a backslash (\verb/\/), and are displayed
in dark red (the same color as sysop warning messages). Who is allowed
to send and recieve mod chat is controlled by two capabilities:
\texttt{seemodchat} and \texttt{sendmodchat}, which do what they sound
like.


\subsection{Multiple commands}

You can specify multiple commands on one line by dividing them with
vertical bars (\verb/|/). The subsequent commands (after the first bar)
don't need question marks (although they are ignored if present). You
can send multiple private commands, but you can't send both public and
private commands on the same line.


\section{Bandwidth Throttling}

\asss{} supports bandwidth throttling for players on slower connections.
To make the game fairer, packets are prioritized depending on their
function. For example, weapons packets will be preferred over chat
messages when deciding how to use up the last few bytes of alloted
bandwidth.

To avoid problems associated with the discontinuity of measuring
bandwith, the server will reserve a certain percentage of the total
bandwith for packets of certain priorities. For example, if a player's
bandwidth limit is 2500 bytes, the server will refuse to use up all 2500
bytes for chat messages in the first half of the monitoring period to
leave space for more important packets that will probably come in the
second half.

% FIXME: include description of the ?{get,set}bandwidth commands


%\section{Lag Control}
%
%
%\section{Regions}
%
%\subsection{What are regions?}
%
%\subsection{Making regions}


\section{Commands}

These are all of the commands that the server currently recognizes. Not
all of them will always be available. If a command requires a module
that isn't likely to be loaded, that will be indicated above its
description. Most other commands require the \texttt{playercmd} module.

Possible targets are listed for each command. The targets can be
``none,'' which refers to commands typed as public (arena) messages,
``player,'' for commands that can target specific players, ``freq,'' for
commands that can target a whole freq at a time (with either \verb/'/ or
\verb/"/), or some restriction of one of those.

Each command also describes any required or optional arguments.

Note that the section doesn't list who is allowed to run a particular
command, because that is determined by the capability manager, which can
be fully customized for each particular server.

\input{commands.tex}


\section{Configuration}

% write stuff about general format of config files:
% sections
% macros/ifdef/ifndef/else/endif
% line continuations

\subsection{Flags}

Until I have time to rework my notes into a nice document, this will
have to do:

\begin{verbatim}
quick guide to transition flag settings:

(all these go in the [Flag] section)

OLD SETTINGS TO KEEP
FlaggerOnRadar=1
FlaggerKillMultiplier=2
FlaggerGunUpgrade=1
FlaggerBombUpgrade=1
FlaggerFireCostPercent=1000
FlaggerDamagePercent=1000
FlaggerBombFireDelay=0
FlaggerSpeedAdjustment=0
FlaggerThrustAdjustment=0
CarryFlags=1                   make sure this agrees with GameType (see below)
FlagDropDelay=3000
FlagDropResetReward=0
EnterGameFlaggingDelay=1000
FlagBlankDelay=200
NoDataFlagDropDelay=500

OLD SETTINGS TO CHANGE
FlagMode=1                     get rid of this, there's a new way to specify game types
FlagResetDelay=1440000         rename to ResetDelay (not currently implemented)
MaxFlags=3                     change to FlagCount=3
RandomFlags=0                  get rid of this, use FlagCount=5-10
FlagReward=2500                keep this
FlagRewardMode=0               change name to SplitPoints
FlagTerritoryRadius=3          get rid of this, use DropRadius
FlagTerritoryRadiusCentroid=0  get rid of this, use DropRadius
FriendlyTransfer=0             keep this the same

NEW SETTINGS
GameType = FLAGGAME_BASIC
  options: FLAGGAME_NONE, FLAGGAME_BASIC, FLAGGAME_TURF, FLAGGAME_CUSTOM
  basic is warzone/running with movable flags. turf is turf (be sure to
  set CarryFlags=0, for now). custom means you have to load a module to
  define a new game. note that those constants are in
  settings/flaggames.h

SpawnX = 512
SpawnY = 512
SpawnRadius = 1024
  define where flags spawn and how far from that center

DropRadius = 2
  how far from a ship will flags drop

NeutRadius = 2
  how far from a ship will neuted flags appear

DropOwned = YES
  are dropped flags owned by the freq?

NeutOwned = NO
  are neuted flags owned by the freq? (obviously, YES prevents neuting)
\end{verbatim}

\subsection{Balls}

FIXME

\subsection{Energy viewing}

There are two arena settings that control whether players see other
player's energy and ship inventory (from spec):

\begin{itemize}

\item{\texttt{Misc:SpecSeeEnergy}} This affects what players in spec
see. If it's set to \verb/SEE_ALL/, a player will see inventory/energy
for the player he is speccing, plus energy for all other players. If
it's \verb/SEE_SPEC/, a player will only see energy/inventory for the
player he is speccing.  \verb/SEE_NONE/ will disable all extra
information for speccers.

\item{\texttt{Misc:SeeEnergy}} If this is set to \verb/SEE_ALL/,
everyone will see everyone else's energy.  If it's \verb/SEE_TEAM/, you
will only see the energy of your teammates. If it's \verb/SEE_NONE/, no
one will see other's energy.

\end{itemize}

In addition, there are two capabilities that override the above
settings. \verb/seeepd/ allows players to see energy/inventory from
spec, and \verb/seenrg/ allows energy viewing while playing.


\section{Acknowledgements}

I'd like to thank the following people and groups:

\begin{itemize}

\item{divine.216} for general support, lots of help testing, banner
support, and many useful suggestions.

\item{Mine GO BOOM} for his ruthless bug-finding and interesting
suggestions, as well as being the first person besides me to actually
contribute code to \asss{}.

\item{Stag Shot} for making sure powerball isn't left out, and other
contributions.

\item{Mr. Ekted} for all his technical help and discussions.

\item{ZippyDan}, ball master, for moral support and comic relief.

\item{xalimar} for shell accounts and hosting, mostly.

\item{numpf} for design critiques. % and hopefully code :)

\item{Remnant} for being the first person to log into \asss{} (besides
me, of course), and help testing.

\item{The rest of the PowerBot chat} for friendly conversation and
entertainment.

\item{The Subspace Council} for not dismissing this project immediately.

% make sure this is correct first
%\item{dgus} for naming ASWZ (a small warzone), which provided
%inspiration for the name of my own server.

\item{D.A.F. (not a subspace player)} for conversations on design and
more.

\end{itemize}

\end{document}

