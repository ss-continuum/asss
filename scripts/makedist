#!/bin/sh

set -e
set -x

umask 022

: using ASSSDIR=${ASSSDIR:=~/src/asss}

cd $ASSSDIR

#d="asss-`date +%Y%m%d`"
d="asss-`sed -n 's/#define ASSSVERSION "\(.*\)"/\1/p' src/defs.h`"

rm -rf $d
cp -a dist $d

tar cf - `grep -lr '[d]ist: public' src scripts doc` scripts/banner.font | \
	(cd $d ; tar xf -)
cp src/Makefile.dist $d/src/Makefile

make -C $d/src install
make -C $d/src clean
make -C ~/src/extra-asss/contenc "ASSSDIR=$ASSSDIR" all
make -C ~/src/extra-asss/contenc "ASSSDIR=$ASSSDIR" clean

cp bin/security.so $d/bin
ln -s '../scripts/bproxy/bproxy' $d/bin/bproxy

make -C doc/userguide "ASSSDIR=$ASSSDIR" all
cp doc/userguide/userguide.{pdf,html,txt} $d/doc
make -C doc/userguide "ASSSDIR=$ASSSDIR" clean

test -d freebsd && cp -a freebsd $d
test -d freebsd || rm -f $d/*freebsd*

find $d -exec touch -r $d/bin/asss {} \;
tar --numeric-owner --exclude CVS -czvf $d.tar.gz $d
#rm -rf $d

