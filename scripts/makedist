#!/bin/sh

set -e
set -x

umask 022

: using ASSSDIR=${ASSSDIR:=~/src/asss}

cd $ASSSDIR

#d="asss-`date +%Y%m%d`"
d="asss-`sed -n 's/#define ASSSVERSION "\(.*\)"/\1/p' src/defs.h`"

rm -rf $d
cp -a dist $d
mkdir $d/{data,log,tmp}

rm -rf doc/doxygen/*
tar cf - `grep -lr '[d]ist: public' src scripts doc` scripts/banner.font | \
	(cd $d ; tar xf -)

make -C $d/src link_db_statically=yes opt=yes install
make -C $d/src cleanbin
rm -f $d/src/Makefile.deps
make -C ~/src/extra-asss/contenc "ASSSDIR=$ASSSDIR" all
make -C ~/src/extra-asss/contenc "ASSSDIR=$ASSSDIR" clean

cp bin/security.so $d/bin
ln -s '../scripts/bproxy/bproxy' $d/bin/bproxy

for subject in user dev; do
	make -C doc/${subject}guide "ASSSDIR=$ASSSDIR" all
	cp doc/${subject}guide/${subject}guide.{pdf,html,txt} $d/doc
	make -C doc/${subject}guide "ASSSDIR=$ASSSDIR" clean
done

test -d freebsd && cp -a freebsd $d
test -d freebsd || rm -f $d/*freebsd*

find $d -name CVS -exec rm -rf {} \; -prune

find $d -exec touch -r $d/bin/asss {} \;
tar --numeric-owner -czvf $d.tar.gz $d

#exit

set +e

# make smaller package
rm -f $d/doc/*.pdf $d/clients/* $d/scrty* $d/arenas/scf/scf.lvl
rm -f $d/bin/* $d/freebsd/bin/*

#find $d -exec touch -r $d/bin/asss {} \;
tar --numeric-owner -czvf $d-srconly.tar.gz $d

rm -rf $d

