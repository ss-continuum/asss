#!/bin/sh

set -e
set -x

umask 022

: using ASSSDIR=${ASSSDIR:=/e/src/asss}
: using CENCDIR=${CENCDIR:=/e/src/contenc}

cd $ASSSDIR

d="asss-`sed -n 's/#define ASSSVERSION "\(.*\)"/\1/p' src/include/defs.h`"

rm -rf $d
cp -a dist $d
mkdir $d/{data,log,tmp}

rm -rf doc/doxygen/*
tar cf - `grep -lr '[d]ist: public' src scripts doc` scripts/banner.font \
	src/asss.dev windeps | \
	(cd $d ; tar xf -)

cp -a ${CENCDIR} $d/src/contenc
make -C $d/src -f Makefile debug=no opt=yes install
rm -rf $d/build $d/src/contenc

rm -f $d/README.freebsd

# supply different readmes on windows
mv -f $d/README.win32 $d/README
mv -f $d/README.developers.win32 $d/README.developers
# comment out unixsignal
sed 's/^unixsignal$/; not on windows: &/' $d/conf/modules.conf > modules.conf.win32
mv -f modules.conf.win32 $d/conf/modules.conf

# package this stuff separately
cd $d
start //wait zip -v -9 -r ../windeps.zip windeps
cd ..
rm -rf $d/windeps

#find $d -exec touch -r $d/bin/asss.exe {} \;

start //wait zip -v -9 -r $d.zip $d

#exit

rm -rf $d/src $d/scripts $d/doc
start //wait zip -v -9 -r $d-binonly.zip $d

rm -rf $d

